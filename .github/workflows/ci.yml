name: CI Pipeline

on:
  workflow_dispatch:
    inputs:
      jira_key:
        description: "Jira issue key"
        required: false
      initiated_by:
        description: "Triggered by"
        required: false

jobs:

  checkout_test:
    name: Checkout & Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Run Test Cases
        run: |
          echo "===== Stage 1: Testing Started ====="
          echo "Running test cases..."
          echo "Test Case 1: Passed"
          echo "Test Case 2: Passed"
          echo "All tests completed"
          echo "===== Stage 1 Completed ====="


  sonar_scan:
    name: Sonar Scan
    needs: checkout_test
    runs-on: ubuntu-latest
    steps:
      - name: Sonar Scan
        run: |
          echo "===== Stage 2: Sonar Scan Started ====="
          echo "Scanning the code with Sonar..."
          echo "Sonar scan completed"
          echo "===== Stage 2 Completed ====="


  dependency_track:
    name: Dependency Track Scan
    needs: sonar_scan
    runs-on: ubuntu-latest
    steps:
      - name: Dependency Track Scan 
        run: |
          echo "===== Stage 3: Dependency Track Started ====="
          echo "Analyzing dependencies..."
          echo "Dependency scan completed"
          echo "===== Stage 3 Completed ====="


  Build_Image:
    name: Build Image
    needs: dependency_track
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Build Docker image
        run: |
          echo "Building Docker image from Dockerfile..."
          docker build -t nginx-demo:latest .
      - name: Save Docker image as artifact
        run: |
          echo "Saving Docker image to tar file..."
          docker save nginx-demo:latest -o nginx-demo.tar
        # upload the image so next stage can use it
      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: nginx-demo-image
          path: nginx-demo.tar


  Deploy_To_Dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: Build_Image
    steps:
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: nginx-demo-image
      - name: Load Docker image
        run: |
          echo "Loading Docker image from tar file..."
          docker load -i nginx-demo.tar
      - name: Run Docker container
        run: |
          echo "Starting container..."
          docker run -d --name nginx-demo -p 8080:80 nginx-demo:latest
          echo "Container started, waiting for Nginx..."
          sleep 5
      - name: Test HTTP response
        run: |
          echo "Testing application with curl..."
          curl -v http://localhost:8080 || (echo "Curl failed" && exit 1)
      - name: Show container logs
        if: always()
        run: |
          echo "===== Container logs ====="
          docker logs nginx-demo || echo "No logs"
      - name: Stop and remove container
        if: always()
        run: |
          echo "Cleaning up..."
          docker rm -f nginx-demo || true